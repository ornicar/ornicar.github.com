<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>Ranger as vim file manager - Hairy blog</title>
    <meta name="description" content="Random geek thoughts of Thibault Duplessis">
    <meta name="author" content="Thibault Duplessis">
    <link href="style.css" rel="stylesheet" type="text/css" />
</head>

<body lang="en" >

    <header>
        <h1><a href="/">Hairy blog</a></h1>
        It's about sharing open source goodness.
    </header>

    <section id="content">
        <article>
            <header>
                <h1>Using ranger as vim file manager</h1>
                <span class="date">Sat Feb 12 23:21:28 PST 2011</span>
            </header>
            <section>
                <h2>The boring introduction</h2>
                <p>
                    I'm a passionate <a href="http://www.archlinux.org">Arch Linux</a> and CLI user.
                    My quest for better tools led me to use <a href="http://www.vim.org">vim</a> for every text-related tasks;
                    and my current file manager of choice is <a href="http://nongnu.org/ranger">ranger</a>.
                </p>
                <p>
                    Ranger is a really great tool when it comes to browse quickly a complex file tree.
                    It also excels at copying/moving/deleting/opening files. You should be using it.
                <p>
                <h2>The problem</h2>
                <p>
                    As a developer, I spend most of my time manipulating text files, so I often switch from vim to ranger.
                    I wish I can open files in vim from ranger. In fact I can, but ranger will open a new vim instance for each file.
                    I want to launch ranger from vim, and open the file I select in the same vim instance.
                </p>
                <h2>The hope</h2>
                <p>
                    One of the great things about open source software is its hackability.
                    Software, by definition, never does exactly what you need.
                    If you think it does, it means you don't know what you need
                    (or you developed the software you use).
                    vim and ranger beeing open source, let's see how we can manage to make them communicate.
                </p>
                <h2>The code</h2>
                <p>
                    ranger code is hosted on GitHub. I pinged <a href="https://github.com/hut">hut</a>, the author, and he gave me some advices on how getting the thing done. And here is the result.
                </p>
                <h3>Ranger hack</h3>

                When the RANGER_RETURN_FILE environment variable is set, ranger behavior is slightly changed.
                Instead of launching an application to open a file,
                it will write the file name in the temp file passed through RANGER_RETURN_FILE, and quit immediatly.

                <pre>diff --git a/ranger/defaults/apps.py b/ranger/defaults/apps.py
index e93ca1b..44f0684 100644
--- a/ranger/defaults/apps.py
+++ b/ranger/defaults/apps.py
@@ -46,6 +46,7 @@ This example modifies the behaviour of "feh" and adds a custom media player:
 #### end of the example
 """

+from tempfile import gettempdir
 from ranger.api.apps import *
 from ranger.ext.get_executables import get_executables

@@ -54,6 +55,12 @@ class CustomApplications(Applications):
                """How to determine the default application?"""
                f = c.file

+               return_file = os.getenv("RANGER_RETURN_FILE")
+               if return_file is not None:
+                       with open(return_file, 'w') as tmp:
+                               tmp.write(f.path)
+                       raise SystemExit()
+
                if f.basename.lower() == 'makefile':
                        return self.either(c, 'make')</pre>

                <a href="https://github.com/ornicar/ranger/compare/f16b6b2bf31c2be04af7...37c4f2d9">View the diff on GitHub</a>

                <h3>.vimrc tweak</h3>

                When &lt;leader&gt;r is pressed, ranger is launched with RANGER_RETURN_FILE environment variable set to a temporary file name.
                After ranger quits, the selected filename is read from the temporary file, and vim opens it.

                <pre>diff --git a/vimrc b/vimrc
index 6ed5971..918b79d 100644
--- a/vimrc
+++ b/vimrc
@@ -261,6 +261,24 @@ com! -nargs=1 Qfdofile try | sil cfirst |
 " Gist
 let g:gist_open_browser_after_post = 1

+" Use ranger as vim file manager
+function! Ranger()
+    " Get a temp file name without creating it
+    let tmpfile = substitute(system('mktemp -u'), '\n', '', '')
+    " Launch ranger, passing it the temp file name
+    silent exec '!RANGER_RETURN_FILE='.tmpfile.' ranger'
+    " If the temp file has been written by ranger
+    if filereadable(tmpfile)
+        " Get the selected file name from the temp file
+        let filetoedit = system('cat '.tmpfile)
+        exec 'edit '.filetoedit
+        call delete(tmpfile)
+    endif
+    redraw!
+endfunction
+
+nmap <leader>r :call Ranger()<cr></pre>

                <a href="https://github.com/ornicar/dotfiles/compare/6f4cb5b4...02526197#diff-28">View the diff on GitHub</a>

                <h2>It works</h2>
                <p>
                    Yeah it's just that simple. I now have my prefered file manager integrated to my prefered code editor.
                    There is a lot of room for improvements in the quick hacks shown above.
                    But what matters is that, even beeing a python and vimscript beginner, I am able to modify my tools.
                    Which leads to the usual conclusion of great blog articles: <strong>Open Source rocks</strong>
                </p>
            </section>
        </article>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = 'hairyblog';
            var disqus_identifier = 'home';
            var disqus_url = 'http://ornicar.github.com';
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
    </section>

    <footer>
    Thibault Duplessis - <a href="http://github.com/ornicar">http://github.com/ornicar</a> - <a href="http://twitter.com/ornicar">http://twitter.com/ornicar</a> | This website is best viewed with your screen turned on
    </footer>
</body>
</html>
